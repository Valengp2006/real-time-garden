<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Jardín Ecológico — Garden</title>
  <style>
    html,body { height:100%; margin:0; background:#0b0b12; color:#eee; font-family:Arial; }
    canvas { display:block; margin:0 auto; background: linear-gradient(#031027, #071022); box-shadow:0 0 30px rgba(0,0,0,0.5); }
    #controls { position:fixed; left:10px; top:10px; background:rgba(0,0,0,0.4); padding:8px; border-radius:6px; }
    button { margin:3px; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="clearBtn">Limpiar Jardín</button>
    <button id="spectateBtn">Abrir Espectador</button>
    <span> | Click = plantar • Hold+move = empujar</span>
  </div>
  <canvas id="c"></canvas>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  const socket = io();
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  function resize() {
    canvas.width = Math.min(window.innerWidth, 1200);
    canvas.height = Math.min(window.innerHeight, 800);
  }
  window.addEventListener('resize', resize);
  resize();

  let seeds = [];

  socket.on('connect', () => {
    console.log('Connected', socket.id);
  });
  socket.on('seedsUpdate', (data) => {
    seeds = data;
  });

  canvas.addEventListener('click', (ev) => {
    const rect = canvas.getBoundingClientRect();
    const x = ev.clientX - rect.left;
    const y = ev.clientY - rect.top;
    socket.emit('plant', { x, y });
  });

  let isDown = false;
  let downPos = null;
  canvas.addEventListener('pointerdown', (e) => {
    isDown = true;
    const r = canvas.getBoundingClientRect();
    downPos = { x: e.clientX - r.left, y: e.clientY - r.top, t: Date.now() };
  });
  canvas.addEventListener('pointerup', (e) => {
    if (!isDown || !downPos) { isDown=false; return; }
    const r = canvas.getBoundingClientRect();
    const up = { x: e.clientX - r.left, y: e.clientY - r.top };
    let nearest = null, dist = 1e9;
    seeds.forEach(s => {
      const dx = s.x - up.x; const dy = s.y - up.y;
      const d = Math.sqrt(dx*dx + dy*dy);
      if (d < dist) { dist = d; nearest = s; }
    });
    if (nearest && dist < 80) {
      const dragDx = up.x - downPos.x;
      const dragDy = up.y - downPos.y;
      const force = Math.min(12, Math.sqrt(dragDx*dragDx + dragDy*dragDy) / 4 + 2);
      socket.emit('nudge', { id: nearest.id, nx: up.x, ny: up.y, force });
    }
    isDown = false;
    downPos = null;
  });

  document.getElementById('clearBtn').addEventListener('click', () => {
    socket.emit('clearGarden');
  });
  document.getElementById('spectateBtn').addEventListener('click', () => {
    window.open('/spectator.html','_blank');
  });

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const g = ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0,'#031027'); g.addColorStop(1,'#071022');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    seeds.forEach(s => {
      const x = Math.max(0, Math.min(canvas.width, s.x));
      const y = Math.max(0, Math.min(canvas.height, s.y));
      ctx.beginPath();
      const grad = ctx.createRadialGradient(x,y,0,x,y, Math.max(20, s.size*3));
      grad.addColorStop(0, `rgba(${s.color.r},${s.color.g},${s.color.b},0.6)`);
      grad.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = grad;
      ctx.arc(x,y, Math.max(20, s.size*3), 0, Math.PI*2);
      ctx.fill();

      ctx.beginPath();
      ctx.fillStyle = `rgba(${s.color.r},${s.color.g},${s.color.b},1)`;
      ctx.arc(x,y, s.size, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = 'rgba(255,255,255,0.7)';
      ctx.font = '10px Arial';
      ctx.fillText(s.age, x + s.size + 4, y + 2);
    });

    ctx.fillStyle = '#eee';
    ctx.font = '12px Arial';
    ctx.fillText(`Semillas: ${seeds.length}`, 12, canvas.height - 10);

    requestAnimationFrame(draw);
  }
  draw();
  </script>
</body>
</html>
